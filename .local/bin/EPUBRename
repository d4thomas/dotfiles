#!/usr/bin/env -S uv run --script
# /// script
# dependencies = []
# ///

import os
import re
from pathlib import Path


def rename_epubs_to_vol1():
    """
    Renames EPUB files to standardize volume format while preserving volume numbers.
    Also removes:
    - Parenthetical text like (Manga)
    - Random hash strings at the end

    Handles patterns like:
    - Volume 2 -> Vol. 02
    - Volume 3 -> Vol. 03
    - Vol. 2 -> Vol. 02
    """
    current_dir = Path.cwd()
    epub_files = list(current_dir.glob("*.epub"))

    if not epub_files:
        print("No EPUB files found in the current directory.")
        return

    print(f"Found {len(epub_files)} EPUB file(s)\n")

    renamed_count = 0

    for epub_file in epub_files:
        original_name = epub_file.name
        new_name = original_name

        # Check if "Light Novel" appears anywhere in the filename
        is_light_novel = bool(re.search(r'\bLight\s+Novel\b', original_name, flags=re.IGNORECASE))

        # Remove author name before the dash (everything up to and including " - ")
        new_name = re.sub(
            r'^[^-]+-\s*',
            '',
            new_name
        )

        # Pattern 1: "Volume X" -> "Vol. 0X" (preserve volume number, pad with zero)
        new_name = re.sub(
            r'\bVolume\s+(\d+)\b',
            lambda m: f'Vol. {int(m.group(1)):02d}',
            new_name,
            flags=re.IGNORECASE
        )

        # Remove parenthetical text like (Manga), (Light Novel), etc.
        new_name = re.sub(
            r'\s*\([^)]*\)',
            '',
            new_name
        )

        # Remove random hash/ID at the end (before .epub)
        # Matches space + 8 hex characters + .epub
        new_name = re.sub(
            r'\s+[a-f0-9]{8}\.epub$',
            '.epub',
            new_name,
            flags=re.IGNORECASE
        )

        # Clean up any extra whitespace
        new_name = re.sub(r'\s+', ' ', new_name).strip()

        # If it's a light novel, add (Light Novel) before .epub
        if is_light_novel:
            new_name = new_name.replace('.epub', ' (Light Novel).epub')

        # Only rename if the name actually changed
        if new_name != original_name:
            new_path = epub_file.parent / new_name

            # Check if target file already exists
            if new_path.exists():
                print(f"⚠️  Skipping: {original_name}")
                print(f"   Target already exists: {new_name}\n")
                continue

            # Perform the rename
            epub_file.rename(new_path)
            renamed_count += 1
            print(f"✓ Renamed:")
            print(f"  From: {original_name}")
            print(f"  To:   {new_name}\n")
        else:
            print(f"- No change needed: {original_name}\n")

    print(f"\n{'='*60}")
    print(f"Summary: Renamed {renamed_count} file(s)")
    print(f"{'='*60}")


if __name__ == "__main__":
    rename_epubs_to_vol1()
