#!/usr/bin/env -S uv run --quiet --script
# /// script
# dependencies = [
#   "lxml>=4.9.0",
# ]
# ///

import sys
import os
import zipfile
import tempfile
from pathlib import Path
from lxml import etree

# Namespace map
NSMAP = {
    'opf': 'http://www.idpf.org/2007/opf',
    'dc': 'http://purl.org/dc/elements/1.1/',
}


def find_opf_file(epub_path):
    """Find the OPF file path within the EPUB"""
    with zipfile.ZipFile(epub_path, 'r') as zip_ref:
        try:
            container_data = zip_ref.read('META-INF/container.xml')
            container_tree = etree.fromstring(container_data)
            rootfile = container_tree.find('.//{urn:oasis:names:tc:opendocument:xmlns:container}rootfile')
            if rootfile is not None:
                return rootfile.get('full-path')
        except:
            pass

        for name in zip_ref.namelist():
            if name.endswith('.opf'):
                return name
    return None


def update_title(epub_file, new_title):
    """Update EPUB title in-place"""
    opf_path = find_opf_file(epub_file)
    if not opf_path:
        print(f"  Error: Could not find OPF file")
        return False

    with tempfile.TemporaryDirectory() as temp_dir:
        # Extract EPUB
        with zipfile.ZipFile(epub_file, 'r') as zip_ref:
            zip_ref.extractall(temp_dir)

        # Parse OPF with lxml
        opf_full_path = os.path.join(temp_dir, opf_path)
        parser = etree.XMLParser(remove_blank_text=False, resolve_entities=False)
        tree = etree.parse(opf_full_path, parser)
        root = tree.getroot()

        # Update title
        title_elem = root.find('.//dc:title', namespaces=NSMAP)
        if title_elem is not None:
            old_title = title_elem.text
            title_elem.text = new_title
            print(f"  '{old_title}' -> '{new_title}'")

            # Update title-sort (file-as) if it exists
            title_id = title_elem.get('id')
            if title_id:
                # Look for <meta refines="#id" property="file-as">
                for meta in root.findall('.//opf:meta', namespaces=NSMAP):
                    if meta.get('refines') == f'#{title_id}' and meta.get('property') == 'file-as':
                        meta.text = new_title
                        print(f"  Updated sort title to '{new_title}'")
                        break
        else:
            print(f"  Error: No title element found")
            return False

        # Write back with exact formatting preserved
        tree.write(opf_full_path, encoding='utf-8', xml_declaration=True, pretty_print=False)

        # Repack EPUB
        with zipfile.ZipFile(epub_file, 'w', zipfile.ZIP_DEFLATED) as zip_out:
            mimetype_path = os.path.join(temp_dir, 'mimetype')
            if os.path.exists(mimetype_path):
                zip_out.write(mimetype_path, 'mimetype', compress_type=zipfile.ZIP_STORED)

            for root_dir, dirs, files in os.walk(temp_dir):
                for file in files:
                    file_path = os.path.join(root_dir, file)
                    arcname = os.path.relpath(file_path, temp_dir)
                    if arcname != 'mimetype':
                        zip_out.write(file_path, arcname)

    return True


def main():
    if len(sys.argv) > 1:
        epub_files = [arg for arg in sys.argv[1:] if arg.lower().endswith('.epub')]
        if not epub_files:
            print("Error: No EPUB files specified")
            sys.exit(1)
    else:
        print("Processing all epub files in current directory...\n")
        epub_files = sorted([f for f in os.listdir('.') if f.lower().endswith('.epub')])

    if not epub_files:
        print("No epub files found")
        sys.exit(0)

    for epub_file in epub_files:
        new_title = Path(epub_file).stem
        print(f"Processing: {epub_file}")
        print(f"Setting title and sort title to: {new_title}")

        if os.path.exists(epub_file):
            update_title(epub_file, new_title)
        else:
            print(f"  Error: File not found")
        print()

    print("Done processing all epub files!")


if __name__ == '__main__':
    main()
