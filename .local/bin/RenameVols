#!/usr/bin/env uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "rich",
# ]
# ///

import os
import re
from rich.console import Console
from rich.table import Table
from rich.prompt import Confirm

def main():
    console = Console()
    current_dir = os.getcwd()
    pattern = re.compile(r'^(.*?) v(\d+)')
    renames = []

    console.print(f"[bold blue]Scanning directory:[/bold blue] {current_dir}\n")
    for filename in os.listdir(current_dir):
        if filename == os.path.basename(__file__):
            continue

        name, ext = os.path.splitext(filename)
        match = pattern.search(name)

        if match:
            title = match.group(1).strip()
            volume = match.group(2)

            volume_padded = volume.zfill(2)

            new_filename = f"{title} Vol. {volume_padded}{ext}"

            if filename != new_filename:
                renames.append((filename, new_filename))

    if not renames:
        console.print("[yellow]No matching files found to rename.[/yellow]")
        return

    table = Table(title=f"Found {len(renames)} files to rename")
    table.add_column("Original Name", style="red")
    table.add_column("New Name", style="green")

    for old, new in renames:
        table.add_row(old, new)

    console.print(table)

    console.print("\n[bold]Check the list above.[/bold]")
    if Confirm.ask("Do you want to proceed with renaming?"):
        count = 0
        for old, new in renames:
            try:
                os.rename(old, new)
                count += 1
            except OSError as e:
                console.print(f"[bold red]Error renaming {old}: {e}[/bold red]")

        console.print(f"\n[bold green]Success! Renamed {count} files.[/bold green]")
    else:
        console.print("[dim]Operation cancelled. No files were changed.[/dim]")

if __name__ == "__main__":
    main()
