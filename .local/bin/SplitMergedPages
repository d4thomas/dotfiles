#!/usr/bin/env uv run --script
# /// script
# requires-python = ">=3.13"
# dependencies = [
#     "PyPDF2",
# ]
# ///

from PyPDF2 import PdfReader, PdfWriter
import copy
import os
import glob

def split_side_by_side_pages(input_pdf_path, output_pdf_path):
    try:
        if not os.path.exists(input_pdf_path):
            print(f"Error: Input file not found at '{input_pdf_path}'")
            return

        reader = PdfReader(input_pdf_path)
        writer = PdfWriter()
        print(f"Processing '{input_pdf_path}'...")
        has_split_pages = False

        for page_num, page in enumerate(reader.pages):
            width = page.mediabox.width
            height = page.mediabox.height

            if width > height:
                print(f"  - Splitting wide page {page_num + 1}...")
                has_split_pages = True
                page_left = copy.deepcopy(page)
                page_right = copy.deepcopy(page)
                mid_point = width / 2
                page_left.cropbox.right = mid_point
                page_right.cropbox.left = mid_point
                writer.add_page(page_right) 
                writer.add_page(page_left)
            else:
                writer.add_page(page)

        if has_split_pages:
            with open(output_pdf_path, "wb") as f_out:
                writer.write(f_out)
            print(f"Successfully processed and saved to '{output_pdf_path}'")
        else:
            print(f"No wide pages found in '{input_pdf_path}'. No output file created.")

    except Exception as e:
        print(f"An error occurred while processing '{input_pdf_path}': {e}")
        print("Please ensure PyPDF2 is installed.")

if __name__ == "__main__":
    print("PDF Wide Page Splitter - Manga Mode (RTL)")
    print("="*40)
    output_dir = "Split_Manga"
    os.makedirs(output_dir, exist_ok=True)
    all_pdfs = glob.glob("*.pdf")
    processed_count = 0

    if not all_pdfs:
        print("\nNo PDF files found in this directory.")
    else:
        print(f"\nFound {len(all_pdfs)} PDF(s)...\n")

    for input_file in all_pdfs:
        base_name = os.path.basename(input_file)
        output_file = os.path.join(output_dir, base_name)

        if os.path.exists(output_file):
            print(f"--- Skipping '{input_file}' (output exists) ---")
            continue

        print(f"--- Processing '{input_file}' ---")
        split_side_by_side_pages(input_file, output_file)
        processed_count += 1

    print(f"\n=============================================")
    print(f"Batch processing complete. Processed {processed_count} new file(s).")