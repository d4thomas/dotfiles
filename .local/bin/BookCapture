#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.10"
# dependencies = [
#     "mss",
#     "pillow",
#     "pynput",
# ]
# ///
"""
Screenshot capture script for Mac with image processing
c: Capture Pages (using mss for direct screenshot)
p: Process Pages
"""

from mss import mss
import time
from PIL import Image
import os
from pathlib import Path
import zipfile
import shutil
from pynput.keyboard import Key, Listener
from pynput import mouse

# SET YOUR CAPTURE REGION HERE
# Format: {"top": y, "left": x, "width": w, "height": h}
CAPTURE_REGION = {'top': 0.0, 'left': 317.93359375, 'width': 2374.484375, 'height': 1691.98046875}

def capture_screenshot(output_path="screenshot.png"):
    """
    Capture a screenshot of the defined region.
    """
    with mss() as sct:
        screenshot = sct.grab(CAPTURE_REGION)
        # Convert to PIL Image and save
        img = Image.frombytes('RGB', screenshot.size, screenshot.rgb)
        img.save(output_path)
        print(f"Screenshot saved: {output_path}")
    return True

def wait_for_navigation():
    """
    Wait for user to press left arrow key, then continue.
    """
    print("Press LEFT ARROW to navigate to next page...")

    pressed = {'done': False}

    def on_press(key):
        if key == Key.left:
            pressed['done'] = True
            return False  # Stop listener

    with Listener(on_press=on_press) as listener:
        listener.join()

    print("Navigating to next page...")
    time.sleep(0.5)  # Small delay after navigation

def find_coordinates():
    """
    Interactive coordinate finder - click two corners to get region coordinates.
    """
    print("\n" + "=" * 50)
    print("FIND SCREEN COORDINATES")
    print("=" * 50)
    print("\nInstructions:")
    print("1. Click the TOP-LEFT corner of the region to capture")
    print("2. Click the BOTTOM-RIGHT corner of the region to capture")
    print("\nReady? Click the TOP-LEFT corner now...")

    clicks = []

    def on_click(x, y, button, pressed):
        if pressed and button == mouse.Button.left:
            clicks.append((x, y))
            if len(clicks) == 1:
                print(f"\n✓ Top-left corner: ({x}, {y})")
                print("\nNow click the BOTTOM-RIGHT corner...")
            elif len(clicks) == 2:
                print(f"✓ Bottom-right corner: ({x}, {y})")

                # Calculate region
                x1, y1 = clicks[0]
                x2, y2 = clicks[1]

                region = {
                    "top": min(y1, y2),
                    "left": min(x1, x2),
                    "width": abs(x2 - x1),
                    "height": abs(y2 - y1)
                }

                print("\n" + "=" * 50)
                print("YOUR CAPTURE REGION:")
                print("=" * 50)
                print(f"\nCAPTURE_REGION = {region}")
                print("\n" + "=" * 50)
                print("Copy the line above and replace line 28 in this script")
                print("=" * 50)

                return False  # Stop listener

    with mouse.Listener(on_click=on_click) as listener:
        listener.join()

def process_images():
    """
    Process manga images:
    1. Find all PNG/JPG images in current directory
    2. Sort by filename
    3. Crop first image (single centered page)
    4. Split remaining images (two-page spreads) into individual pages
    """
    # Ask for reading direction
    print("\nReading direction:")
    print("Press Enter for Right-to-Left")
    print("Type 'ltr' for Left-to-Right")
    choice = input("Choice: ").strip().lower()
    rtl = choice != 'ltr'
    direction = "Right-to-Left" if rtl else "Left-to-Right"
    print(f"Using {direction} mode...\n")

    # Get all image files (looking for screenshot files)
    image_extensions = ('.png', '.jpg', '.jpeg', '.PNG', '.JPG', '.JPEG')
    images = [f for f in os.listdir('.') if f.endswith(image_extensions) and 'screenshot_' in f]

    if not images:
        print("No images found in current directory!")
        return

    # Sort by filename (which includes timestamp and count)
    images.sort()
    print(f"Found {len(images)} images")
    print("Processing in this order:")
    for i, img in enumerate(images, 1):
        print(f"  {i}. {img}")

    # Create output directory
    output_dir = Path('processed')
    output_dir.mkdir(exist_ok=True)

    page_number = 1

    for idx, img_file in enumerate(images):
        print(f"Processing {img_file}...")
        img = Image.open(img_file)
        # Convert RGBA to RGB if needed
        if img.mode == 'RGBA':
            img = img.convert('RGB')
        width, height = img.size

        if idx == 0:
            # First image - single page centered, crop to fit
            # Assuming the page is centered, crop to half width
            left = width // 4
            right = left + (width // 2)
            cropped = img.crop((left, 0, right, height))
            output_path = output_dir / f"{page_number:03d}.jpg"
            cropped.save(output_path, 'JPEG', quality=85, optimize=True)
            print(f"  Saved cropped single page as {output_path}")
            page_number += 1
        else:
            # Two-page spread - split into two images
            mid = width // 2

            # In digital manga readers, the screen layout is:
            # RTL: [Right page | Left page] (left side of screen is read first)
            # LTR: [Left page | Right page] (left side of screen is read first)

            left_half = img.crop((0, 0, mid, height))
            right_half = img.crop((mid, 0, width, height))

            if rtl:
                # RTL: Right side of screen is read first, then left side
                first_path = output_dir / f"{page_number:03d}.jpg"
                right_half.save(first_path, 'JPEG', quality=85, optimize=True)
                print(f"  Saved page {page_number} (right page)")
                page_number += 1

                second_path = output_dir / f"{page_number:03d}.jpg"
                left_half.save(second_path, 'JPEG', quality=85, optimize=True)
                print(f"  Saved page {page_number} (left page)")
                page_number += 1
            else:
                # LTR: Left side of screen = Left page (read first)
                first_path = output_dir / f"{page_number:03d}.jpg"
                left_half.save(first_path, 'JPEG', quality=85, optimize=True)
                print(f"  Saved page {page_number} (left page)")
                page_number += 1

                second_path = output_dir / f"{page_number:03d}.jpg"
                right_half.save(second_path, 'JPEG', quality=85, optimize=True)
                print(f"  Saved page {page_number} (right page)")
                page_number += 1

    print(f"\n✓ Processing complete! {page_number - 1} pages created")

    # Create CBZ file
    print("\nCreating CBZ archive...")
    current_dir_name = Path.cwd().name
    cbz_filename = f"{current_dir_name}.cbz"
    with zipfile.ZipFile(cbz_filename, 'w', zipfile.ZIP_DEFLATED) as cbz:
        # Add all processed JPGs to the CBZ in correct numerical order
        processed_files = sorted(output_dir.glob('*.jpg'), key=lambda x: x.name)
        for jpg_file in processed_files:
            cbz.write(jpg_file, jpg_file.name)
            print(f"  Added {jpg_file.name} to archive")

    print(f"✓ Created {cbz_filename}")

    # Move original captured images to a separate folder
    print("\nOrganizing original images...")
    originals_dir = Path('originals')
    originals_dir.mkdir(exist_ok=True)

    for img_file in images:
        src = Path(img_file)
        dst = originals_dir / img_file
        shutil.move(str(src), str(dst))
        print(f"  Moved {img_file} to originals/")

    # Remove the processed directory
    print(f"\nCleaning up {output_dir}/...")
    shutil.rmtree(output_dir)

    print("\n" + "=" * 50)
    print("All done!")
    print(f"Saved as: {cbz_filename}")
    print("=" * 50)

def run_capture():
    """Run the continuous capture automation"""
    print("=" * 50)
    print("SCREENSHOT CAPTURE MODE")
    print("=" * 50)
    print(f"Using capture region: {CAPTURE_REGION}")
    print("\nStarting capture loop...")
    print("After each capture, press LEFT ARROW to continue")
    print("Press Ctrl+C to stop")
    print("=" * 50)
    time.sleep(2)

    try:
        count = 1
        while True:
            print(f"\n--- Capture {count} ---")

            # Generate filename with timestamp or count
            timestamp = time.strftime("%Y%m%d_%H%M%S")
            filename = f"screenshot_{timestamp}_{count:03d}.png"

            if capture_screenshot(filename):
                print(f"✓ Captured page {count}")
                wait_for_navigation()
                count += 1
            else:
                print("Capture failed. Stopping...")
                break

    except KeyboardInterrupt:
        print("\n\nCapture stopped. Returning to menu...")

if __name__ == "__main__":
    while True:
        print("\n" + "=" * 50)
        print("SCREENSHOT CAPTURE & PROCESSOR")
        print("=" * 50)
        print("\nMenu:")
        print("  c - Capture")
        print("  f - Find Coordinates")
        print("  p - Process Pages")
        print("  q - Quit")

        choice = input("Choice (c/f/p/q): ").strip().lower()

        if choice == 'c':
            run_capture()
        elif choice == 'f':
            find_coordinates()
        elif choice == 'p':
            process_images()
        elif choice == 'q':
            print("\nGoodbye!")
            break
        else:
            print("Invalid choice. Please choose 'c', 'f', 'p', or 'q'.")
