#!/usr/bin/env -S uv run --script

import os
import sys
from pathlib import Path

# Configuration
ROOT_DIR = Path("/Users/daniel/Library/Mobile Documents/com~apple~CloudDocs/Books")

def count_epubs(directory):
    """Count all epub files in a directory recursively."""
    if not os.path.exists(directory):
        return 0

    path = Path(directory)
    return len(list(path.rglob("*.epub")))

def show_series_breakdown(category_dir, category_name):
    """Show breakdown of series (subdirectories) with epub counts."""
    category_path = ROOT_DIR / category_dir
    if not os.path.exists(category_path):
        print(f"Directory '{category_dir}' not found.")
        return

    print(f"\n{category_name}")
    print("-" * 40)

    # Get all subdirectories with their counts
    subdirs = sorted([d for d in category_path.iterdir() if d.is_dir()])

    for subdir in subdirs:
        count = count_epubs(subdir)
        if count > 0:
            print(f"{subdir.name} [{count}]")

def show_counts():
    """Show overall counts for all categories."""
    categories = {
        "Manga": "Manga",
        "Light Novels": "Light Novels",
        "Manga Loans": "Loans/Manga",
        "Light Novel Loans": "Loans/Light Novels"
    }

    total = 0
    for label, directory in categories.items():
        dir_path = ROOT_DIR / directory
        count = count_epubs(dir_path)
        print(f"{label}: {count}")
        total += count

    print(f"Total: {total}")

def show_all_series():
    """Show series breakdown for all categories."""
    categories = [
        ("Manga", "Manga"),
        ("Light Novels", "Light Novels"),
        ("Manga Loans", "Loans/Manga"),
        ("Light Novel Loans", "Loans/Light Novels")
    ]

    for label, directory in categories:
        show_series_breakdown(directory, label)

def show_help():
    """Show help message."""
    print("Usage: ./LibSummary [category]")
    print()
    print("Categories:")
    print("  (no arg)                 - Show overall counts (default)")
    print("  all, --all               - Show all series for all categories")
    print("  manga, m                 - Show Manga series breakdown")
    print("  light-novels, ln         - Show Light Novels series breakdown")
    print("  manga-loans, ml          - Show Manga Loans series breakdown")
    print("  light-novel-loans, lnl   - Show Light Novel Loans series breakdown")
    print("  help, --help, -h         - Show this help message")

def main():
    # Get command line argument
    arg = sys.argv[1].lower() if len(sys.argv) > 1 else ""

    if arg in ["all", "--all"]:
        show_all_series()
    elif arg in ["manga", "m"]:
        show_series_breakdown("Manga", "Manga")
    elif arg in ["light-novels", "ln"]:
        show_series_breakdown("Light Novels", "Light Novels")
    elif arg in ["manga-loans", "ml"]:
        show_series_breakdown("Loans/Manga", "Manga Loans")
    elif arg in ["light-novel-loans", "lnl"]:
        show_series_breakdown("Loans/Light Novels", "Light Novel Loans")
    elif arg in ["help", "--help", "-h"]:
        show_help()
    elif arg == "":
        show_counts()
    else:
        print(f"Unknown category: {arg}")
        sys.exit(1)

if __name__ == "__main__":
    main()
